{% extends "base.html" %}
{% block content %}
<h2>Gestione assenze</h2>

<div class="layout-flex" style="gap: 32px;">

  <!-- ▬▬▬▬▬▬▬▬▬ COLONNA SINISTRA → INSERIMENTO ASSENZA ▬▬▬▬▬▬▬▬▬ -->
  <div class="col">
    <h3>Inserisci Assenza da orario</h3>
    <form method="post">
        <div>
            <label>Docente</label><br>
            <select name="docente_id" required>
                <option value="">-- Seleziona docente --</option>
                {% for d in docenti %}
                    <option value="{{ d.id }}">
                        {{ d.cognome }}{% if d.nome %} {{ d.nome }}{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label>Dal giorno</label><br>
            <input type="date"
                   name="data_inizio"
                   required
                   value="{{ data_oggi }}">
        </div>

        <div>
            <label>Al giorno (facoltativo)</label><br>
            <input type="date" name="data_fine">
            <div style="font-size:12px;color:#555;">
                Se lasci vuoto, l'assenza vale solo per il giorno iniziale.
            </div>
        </div>

        <div>
            <label>Note (facoltative)</label><br>
            <textarea name="note" rows="2"></textarea>
        </div>

        <div style="margin-top:10px;">
            <button type="submit">
                Inserisci / aggiorna assenza da orario
            </button>
        </div>
    </form>
  </div>

  <!-- ▬▬▬▬▬▬▬▬▬ COLONNA DESTRA → FILTRI + VISTA + RISULTATI ▬▬▬▬▬▬▬▬▬ -->
  <div class="col">

    <!-- FILTRI -->
    <h3>Filtra assenze</h3>
    <form method="get">
        <div>
            <label>Docente</label><br>
            <select name="f_docente_id">
                <option value="">-- Tutti --</option>
                {% for d in docenti %}
                    <option value="{{ d.id }}"
                        {% if f_docente_id and f_docente_id|int == d.id %}selected{% endif %}>
                        {{ d.cognome }}{% if d.nome %} {{ d.nome }}{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label>Giorno</label><br>
            <input type="date" name="f_data"
                   {% if f_data %}value="{{ f_data }}"{% endif %}>
        </div>

        <div>
            <label>Vista</label><br>
            <select name="view">
                <option value="compact"
                    {% if view_mode == 'compact' %}selected{% endif %}>
                    Compatta (docente + giorno)
                </option>
                <option value="extended"
                    {% if view_mode == 'extended' %}selected{% endif %}>
                    Estesa (docente + giorno + ora)
                </option>
            </select>
        </div>

        <div style="margin-top:10px;">
            <button type="submit">Applica filtri / vista</button>
            <a href="{{ url_for('gestione_assenze') }}">Azzera filtri</a>
        </div>
    </form>

    <hr style="margin:20px 0;">

    <!-- ▬▬▬▬▬▬▬ VISTA COMPATTA ▬▬▬▬▬▬▬ -->
    {% if view_mode == 'compact' %}
      <h3>Assenze (vista compatta)</h3>
      <div class="table-wrapper">
        <table>
            <tr>
                <th>Data</th>
                <th>Docente</th>
                <th>Ore</th>
                <th>Note</th>
            </tr>
            {% for a in assenze %}
                <tr>
                    <td>{{ a.data.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {{ a.docente.cognome }}
                        {% if a.docente.nome %} {{ a.docente.nome }}{% endif %}
                    </td>
                    <td>{{ a.ore }}</td>
                    <td>{{ a.note }}</td>
                </tr>
            {% endfor %}
        </table>
      </div>

    <!-- ▬▬▬▬▬▬▬ VISTA ESTESA ▬▬▬▬▬▬▬ -->
    {% else %}
      <h3>Assenze (vista estesa)</h3>
      <div class="table-wrapper">
        <table>
            <tr>
                <th>Data</th>
                <th>Docente</th>
                <th>Ora</th>
                <th>Note</th>
                <th>Azioni</th>
            </tr>
            {% for a in assenze %}
                {% set ore_list = (a.ore or '').split(',') %}
                {% for ora in ore_list %}
                    {% if ora %}
                    <tr>
                        <td>{{ a.data.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {{ a.docente.cognome }}
                            {% if a.docente.nome %} {{ a.docente.nome }}{% endif %}
                        </td>
                        <td>{{ ora }}</td>
                        <td>{{ a.note }}</td>
                        <td>
                            <form method="post"
                                  action="{{ url_for('cancella_assenza_ora') }}"
                                  style="display:inline;">
                                <input type="hidden" name="assenza_id" value="{{ a.id }}">
                                <input type="hidden" name="ora" value="{{ ora }}">
                                <button type="submit"
                                        onclick="return confirm('Eliminare ora {{ ora }}?');">
                                    Elimina
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </table>
      </div>
    {% endif %}

  </div>
</div>

{% endblock %}

